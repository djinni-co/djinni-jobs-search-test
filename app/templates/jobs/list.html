{% extends "base.html" %}

{% load filter %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
  <!-- This should be in base.html. But I can't modify it :( -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">

  <div class="container">
    <header class="pt-4 pb-4">
      <h1>Jobs on Djinni</h1>
      <div class="mb-4">
        <form method="GET">
          <div class="row">
              <div class="col-sm-6">
                <input type="text" name="q" value="{{ request.GET.q }}" class="form-control" placeholder="Search jobs (e.g., python -java -javascript)">
                <small class="form-text text-muted">Use `-` before a term to exclude it from search results (e.g., python -java excludes jobs containing 'java').</small>
              </div>
              <div class="col-auto">
                  <button type="submit" class="btn btn-primary">Search</button>
              </div>
          </div>
        </form>
      </div>
      {% if query %}
      <div class="alert alert-info">
        <h4 class="alert-heading">Search Results</h4>
        <p class="mb-0">Search results for: <strong>{{ query }}</strong></p>
        <p class="mb-0">Total jobs found: <strong>{{ total_jobs }}</strong></p>
      </div>
      {% endif %}
    </header>
    <div class="page-content"> 
      <section class="row">
          <div class="col-lg-8">
              <div class="row">
                <div id="jobs_list">
                  <div class="row">
                    <div class="col-sm-8">
                      {% for job in jobs %}
                      <div id="job_{{ job.id }}" class="mb-5">
                        <h2 class="h4 text-primary">
                          {{ job.position }}
                          {% if job.public_salary_max %}
                            <span class="text-success">to ${{ job.public_salary_max }}</span>
                          {% endif %}
                          <small class="text-secondary">at {{ job.company.name }}</small>
                        </h2>
                    
                        <div class="mb-2">
                          <!-- Domain -->
                          {% if job.domain %}
                            <span class="badge bg-info">Domain: {{ job.get_domain_display }}</span>
                          {% endif %}
                          
                          <!-- Experience Years -->
                          {% if job.experience_years %}
                            <span class="badge bg-secondary">Experience: {{ job.experience_years }} years</span>
                          {% endif %}
                          
                          <!-- Location and Country -->
                          {% if job.location or job.country %}
                            <span class="badge bg-primary">
                              Location: {{ job.location }}{% if job.country %}, {{ job.country }}{% endif %}
                            </span>
                          {% endif %}
                          
                          <!-- Remote Type -->
                          {% if job.remote_type %}
                            <span class="badge bg-warning">{{ job.get_remote_type_display }}</span>
                          {% endif %}
                          
                          <!-- Part-time Indicator -->
                          {% if job.is_parttime %}
                            <span class="badge bg-success">Part-time</span>
                          {% endif %}
                        </div>
                        
                        <div>
                          <div class="text-clamp" id="short_{{ job.id }}">
                            {{ job.long_description|striptags|replace_nbsp|truncatewords:50 }}
                            <a href="javascript:void(0);" onclick="toggleDescription({{ job.id }});">Read more</a>
                          </div>
                          <div class="d-none" id="full_{{ job.id }}">
                            {{ job.long_description|highlight:query|safe }}
                            <a href="javascript:void(0);" onclick="toggleDescription({{ job.id }});">Read less</a>
                          </div>
                        </div>
                        
                        <p class="text-muted d-flex align-items-center">
                          <i class="bi bi-calendar-event me-2"></i> {{ job.published|date:"F j, Y" }}
                          <span class="mx-2">|</span>
                          <i class="bi bi-eye me-2"></i> {{ job.views_count }}
                          <span class="mx-2">|</span>
                          <i class="bi bi-journal-check me-2"></i> {{ job.applications_count }}
                        </p>
                      
                      </div>
                      {% endfor %}
                    
                      <div class="pagination">
                        <ul class="pagination justify-content-center">
                          {% if jobs.has_previous %}
                            <li class="page-item">
                              <a class="page-link" href="?{% for key, value in request.GET.items %}{{ key }}={{ value|urlencode }}&{% endfor %}page=1" aria-label="First">
                                <span aria-hidden="true">&laquo;</span>
                              </a>
                            </li>
                            <li class="page-item">
                              <a class="page-link" href="?{% for key, value in request.GET.items %}{{ key }}={{ value|urlencode }}&{% endfor %}page={{ jobs.previous_page_number }}" aria-label="Previous">
                                <span aria-hidden="true">&lsaquo;</span>
                              </a>
                            </li>
                          {% endif %}
                      
                          {% for num in jobs.paginator.page_range %}
                            {% if num > jobs.number|add:'-3' and num < jobs.number|add:'3' %}
                              {% if num == jobs.number %}
                                <li class="page-item active">
                                  <span class="page-link">{{ num }}</span>
                                </li>
                              {% else %}
                                <li class="page-item">
                                  <a class="page-link" href="?{% for key, value in request.GET.items %}{{ key }}={{ value|urlencode }}&{% endfor %}page={{ num }}">{{ num }}</a>
                                </li>
                              {% endif %}
                            {% endif %}
                          {% endfor %}
                      
                          {% if jobs.has_next %}
                            <li class="page-item">
                              <a class="page-link" href="?{% for key, value in request.GET.items %}{{ key }}={{ value|urlencode }}&{% endfor %}page={{ jobs.next_page_number }}" aria-label="Next">
                                <span aria-hidden="true">&rsaquo;</span>
                              </a>
                            </li>
                            <li class="page-item">
                              <a class="page-link" href="?{% for key, value in request.GET.items %}{{ key }}={{ value|urlencode }}&{% endfor %}page={{ jobs.paginator.num_pages }}" aria-label="Last">
                                <span aria-hidden="true">&raquo;</span>
                              </a>
                            </li>
                          {% endif %}
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
          </div>

          <div class="col-lg-4">
            <div class="card">
              <div class="card-title">
                <h3 class="h4 mb-0">Job filter</h3>
              </div>
              <div class="card-body">
                <form method="get">
                  <input type="hidden" name="q" value="{{ query }}">
                  <div class="mb-3">
                    {{ filter.form.position|as_crispy_field }}
                  </div>
                  <div class="mb-3">
                    {{ filter.form.domain|as_crispy_field }}
                  </div>
                  <div class="mb-3">
                    {{ filter.form.english_level|as_crispy_field }}
                  </div>
                  <div class="mb-3">
                    {{ filter.form.country|as_crispy_field }}
                  </div>
                  <div class="mb-3">
                    {{ filter.form.location|as_crispy_field }}
                  </div>
                  <div class="mb-3">
                    {{ filter.form.company_type|as_crispy_field }}
                  </div>
                  <div class="mb-3">
                    {{ filter.form.experience_years|as_crispy_field }}
                  </div>
                  <div class="mb-3">
                    {{ filter.form.accept_region|as_crispy_field }}
                  </div>
                  <div class="mb-3">
                    {{ filter.form.remote_type|as_crispy_field }}
                  </div>
                  <div class="mb-3">
                    {{ filter.form.sort_by|as_crispy_field }}
                  </div>
                  <div class="mb-3">
                    {{ filter.form.salary_min.label_tag }}
                    <input type="range" name="salary_min" min="100" max="10000" step="100" value="{{ filter.data.salary_min|default:'0' }}" class="form-range" id="salaryRange">
                    <span>від $<span id="salaryValue">{{ filter.data.salary_min|default:'100' }}</span></span>
                  </div>
                  <div class="d-flex justify-content-between">
                    <a href="{% url 'jobs_list' %}" class="btn btn-secondary flex-grow-1 me-2 d-flex align-items-center justify-content-center">
                        <i class="bi bi-x-circle me-2"></i>Cancel Filters
                    </a>
                    <button type="submit" class="btn btn-primary flex-grow-1 ms-2 d-flex align-items-center justify-content-center">
                        <i class="bi bi-funnel me-2"></i>Filter
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
      </section>
    </div>
  </div>
    <script src="{% static 'js/desc.js' %}"></script>
    <script src="{% static 'js/range.js' %}"></script>
    <script src="{% static 'js/sel2.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
{% endblock content %}
